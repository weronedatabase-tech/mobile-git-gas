<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MobileGit+GAS</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 950: '#0f172a' } },
                    spacing: { 'safe-top': 'env(safe-area-inset-top)', 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); min-height: 100vh; }
        .loader { border: 3px solid rgba(128,128,128,0.3); border-radius: 50%; border-top: 3px solid #3b82f6; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        textarea, input, select { font-size: 14px !important; }
        #error-box { display: none; margin: 10px; padding: 10px; background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; border-radius: 6px; font-family: monospace; word-break: break-all; font-size: 12px; }
        html.dark #error-box { background: #7f1d1d; color: #fecaca; }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        html.dark .modal-bg { background: rgba(0,0,0,0.8); }
        .menu-dropdown { position: absolute; top: 50px; right: 8px; width: 200px; z-index: 60; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 200; white-space: nowrap; }
        .toast.show { opacity: 1; }
    </style>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-50 text-slate-900 dark:bg-slate-950 dark:text-gray-100 transition-colors duration-200">

    <div id="loading-ui" class="text-center p-10 text-slate-500">
        <div class="loader"></div>
        <p class="text-xs mt-2">Loading...</p>
        <button onclick="localStorage.clear(); window.location.reload()" class="mt-4 text-xs text-blue-500 underline">Reset</button>
    </div>

    <div id="error-box"></div>
    <div id="root"></div>
    <div id="toast" class="toast">Message</div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from "https://esm.sh/react@18.2.0";
        import { createRoot } from "https://esm.sh/react-dom@18.2.0/client";
        import { Octokit } from "https://esm.sh/@octokit/rest@20.0.1";

        const GITHUB_CLIENT_ID = "Ov23liwbmxvn9qmImYMZ"; 
        const GAS_PROXY_URL = "https://script.google.com/macros/s/AKfycbw83udtxsHNQ2bnJLikBePT6QM3-hkNWf-8Rci7QhXPYQAasSLEo_snW0n1uK6SQDaY/exec";
        const GOOGLE_CLIENT_ID = "91778409538-4i31u5ia07ibb4o1ctv5c1sr7jpv3k1k.apps.googleusercontent.com"; 
        
        // SCOPES: Full Drive access required to see linked scripts and delete projects
        const GOOGLE_SCOPES = "https://www.googleapis.com/auth/script.projects https://www.googleapis.com/auth/script.deployments https://www.googleapis.com/auth/drive";

        // --- ICONS ---
        const Icons = {
            Folder: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500 w-5 h-5"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/></svg>,
            File: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-emerald-500 w-5 h-5"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Back: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Logout: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Git: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><circle cx="12" cy="12" r="3"/><line x1="12" x2="12" y1="3" y2="9"/><line x1="12" x2="12" y1="15" y2="21"/></svg>,
            Drive: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><path d="M15 3h6v18h-6M10 17l5-5-5-5M13.8 21H21V3h-7.2"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Zap: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
            Globe: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>,
            Link: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>,
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
            Paste: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        };

        function App() {
            const [theme, setTheme] = useState(localStorage.getItem("theme") || "dark");
            useEffect(() => { document.documentElement.classList.toggle('dark', theme === 'dark'); localStorage.setItem("theme", theme); }, [theme]);
            const toggleTheme = () => setTheme(t => t === 'dark' ? 'light' : 'dark');

            const [service, setService] = useState(localStorage.getItem("service") || "git");
            const [ghToken, setGhToken] = useState(localStorage.getItem("gh_token"));
            const [gasToken, setGasToken] = useState(localStorage.getItem("gas_token"));
            
            const [view, setView] = useState("repos");
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            
            const [repos, setRepos] = useState([]);
            const [files, setFiles] = useState([]);
            const [currentRepo, setCurrentRepo] = useState(null);
            const [path, setPath] = useState("");
            
            const [fileContent, setFileContent] = useState("");
            const [fileSha, setFileSha] = useState(""); 
            const [filePath, setFilePath] = useState("");
            const [commitMsg, setCommitMsg] = useState("Update");
            
            const [modalMode, setModalMode] = useState(null);
            const [inputName, setInputName] = useState("");
            const [deployDesc, setDeployDesc] = useState("New Version");
            const [showGlobalMenu, setShowGlobalMenu] = useState(false);
            const [manualPasteText, setManualPasteText] = useState("");

            const [gasAccess, setGasAccess] = useState("ANYONE_ANONYMOUS");
            const [gasExecute, setGasExecute] = useState("USER_DEPLOYING");

            useEffect(() => { document.getElementById('loading-ui').style.display = 'none'; }, []);

            function toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
            const formatDate = (d) => d ? new Date(d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : '';

            // --- AUTH ---
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get("code");
                if (code && !ghToken) {
                    setLoading(true);
                    window.history.replaceState({}, document.title, window.location.href.split('?')[0]);
                    fetch(`${GAS_PROXY_URL}?code=${code}`).then(res => res.json()).then(data => {
                        if (data.access_token) { localStorage.setItem("gh_token", data.access_token); setGhToken(data.access_token); setService('git'); }
                    }).catch(e => setError(e.message)).finally(() => setLoading(false));
                }
            }, [ghToken]);

            const googleLogin = () => {
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: GOOGLE_SCOPES,
                    callback: (resp) => {
                        if (resp.access_token) { localStorage.setItem("gas_token", resp.access_token); setGasToken(resp.access_token); setService('gas'); }
                    },
                });
                client.requestAccessToken();
            };

            const logout = () => {
                if(service === 'git') { localStorage.removeItem("gh_token"); setGhToken(null); }
                else { localStorage.removeItem("gas_token"); setGasToken(null); }
                setRepos([]); setView("repos"); setShowGlobalMenu(false);
            };

            const octokit = useMemo(() => ghToken ? new Octokit({ auth: ghToken }) : null, [ghToken]);
            
            const gasFetch = async (url, method = "GET", body = null) => {
                const res = await fetch(url, {
                    method,
                    headers: { Authorization: `Bearer ${gasToken}`, "Content-Type": "application/json" },
                    body: body ? JSON.stringify(body) : null
                });
                if (!res.ok) {
                    if (res.status === 401) logout();
                    const err = await res.json();
                    throw new Error(err.error?.message || "GAS API Error");
                }
                if (res.status === 204) return null; // Handle No Content (Delete)
                return res.json();
            };

            // --- LOAD DATA ---
            const loadData = async () => {
                setLoading(true); setError(null);
                try {
                    if (service === 'git' && ghToken) {
                        const res = await octokit.repos.listForAuthenticatedUser({ sort: "updated", per_page: 30 });
                        setRepos(res.data);
                    } else if (service === 'gas' && gasToken) {
                        // FIX: Added includeItemsFromAllDrives and supportsAllDrives to find linked/bound scripts
                        const res = await gasFetch("https://www.googleapis.com/drive/v3/files?q=mimeType='application/vnd.google-apps.script' and trashed=false&fields=files(id, name, modifiedTime)&orderBy=modifiedTime desc&pageSize=100&includeItemsFromAllDrives=true&supportsAllDrives=true");
                        const projects = (res.files || []).map(f => ({ ...f, scriptId: f.id, updated_at: f.modifiedTime }));
                        setRepos(projects);
                    }
                    setView("repos");
                } catch(e) { setError(e.message); }
                setLoading(false);
            };

            useEffect(() => { if((service === 'git' && ghToken) || (service === 'gas' && gasToken)) loadData(); }, [service, ghToken, gasToken, octokit]);

            const loadFiles = async (item) => {
                setLoading(true); setError(null);
                try {
                    if (service === 'git') {
                        const res = await octokit.repos.getContent({ owner: item.owner.login, repo: item.name, path: "" });
                        const data = Array.isArray(res.data) ? res.data : [res.data];
                        data.sort((a, b) => (b.type === "dir" ? 1 : 0) - (a.type === "dir" ? 1 : 0));
                        setFiles(data); setCurrentRepo(item); setPath("");
                    } else {
                        const res = await gasFetch(`https://script.googleapis.com/v1/projects/${item.scriptId}/content`);
                        const mapped = (res.files || []).map(f => ({ 
                            name: f.name + (f.type==='HTML'?'.html':'.gs'), 
                            type: 'file', 
                            sha: f.name, 
                            rawType: f.type, 
                            source: f.source 
                        }));
                        setFiles(mapped); setCurrentRepo(item); setPath("");
                    }
                    setView("files");
                } catch(e) { setError("Open failed."); }
                setLoading(false);
            };

            const openFile = async (file) => {
                setLoading(true); setError(null);
                try {
                    if (service === 'git') {
                        const res = await octokit.repos.getContent({ owner: currentRepo.owner.login, repo: currentRepo.name, path: file.path });
                        const content = new TextDecoder().decode(Uint8Array.from(atob(res.data.content.replace(/\n/g, "")), c => c.charCodeAt(0)));
                        setFileContent(content); setFileSha(res.data.sha); setFilePath(file.path);
                    } else {
                        setFileContent(file.source || ""); setFileSha(file.sha); setFilePath(file.name); 
                    }
                    setView("editor");
                } catch(e) { setError("Read failed."); }
                setLoading(false);
            };

            // --- SAVE / DELETE / RENAME LOGIC ---
            const saveFile = async () => {
                setLoading(true);
                try {
                    if (service === 'git') {
                        const contentEncoded = btoa(new TextEncoder().encode(fileContent).reduce((d, b) => d + String.fromCharCode(b), ''));
                        const payload = { owner: currentRepo.owner.login, repo: currentRepo.name, path: filePath, message: commitMsg, content: contentEncoded };
                        if (fileSha) payload.sha = fileSha;
                        await octokit.repos.createOrUpdateFileContents(payload);
                    } else {
                        const res = await gasFetch(`https://script.googleapis.com/v1/projects/${currentRepo.scriptId}/content`);
                        const newFiles = res.files.map(f => {
                            const fname = f.name + (f.type==='HTML'?'.html':'.gs');
                            return fname === filePath ? { ...f, source: fileContent } : f;
                        });
                        if(!res.files.find(f => (f.name + (f.type==='HTML'?'.html':'.gs')) === filePath)) {
                            const name = filePath.replace(/\.(gs|html)$/, "");
                            const type = filePath.endsWith(".html") ? "HTML" : "SERVER_JS";
                            newFiles.push({ name, type, source: fileContent });
                        }
                        await gasFetch(`https://script.googleapis.com/v1/projects/${currentRepo.scriptId}/content`, "PUT", { files: newFiles });
                        const mapped = newFiles.map(f => ({ name: f.name + (f.type==='HTML'?'.html':'.gs'), type: 'file', sha: f.name, rawType: f.type, source: f.source }));
                        setFiles(mapped);
                    }
                    toast("Saved!");
                    if(service === 'git') loadFiles(currentRepo); 
                } catch(e) { setError("Save failed: " + e.message); }
                setLoading(false);
            };

            const performDeleteFile = async (file) => {
                if(!confirm(`Delete ${file.name}?`)) return;
                setLoading(true);
                try {
                    if (service === 'git') {
                        await octokit.repos.deleteFile({ owner: currentRepo.owner.login, repo: currentRepo.name, path: file.path, message: "Delete " + file.name, sha: file.sha });
                    } else {
                        const res = await gasFetch(`https://script.googleapis.com/v1/projects/${currentRepo.scriptId}/content`);
                        const targetName = file.name.replace(/\.(gs|html)$/, "");
                        const newFiles = res.files.filter(f => f.name !== targetName);
                        await gasFetch(`https://script.googleapis.com/v1/projects/${currentRepo.scriptId}/content`, "PUT", { files: newFiles });
                    }
                    toast("Deleted");
                    loadFiles(currentRepo);
                } catch(e) { alert("Delete failed: " + e.message); }
                setLoading(false);
            };

            const performRename = async () => {
                if(!inputName) return;
                setLoading(true);
                try {
                    if(modalMode === 'renameRepo') {
                        if(service === 'git') {
                            await octokit.repos.update({ owner: currentRepo.owner.login, repo: currentRepo.name, name: inputName });
                        } else {
                            await gasFetch(`https://www.googleapis.com/drive/v3/files/${currentRepo.scriptId}`, "PATCH", { name: inputName });
                        }
                        toast("Renamed Project");
                        loadData();
                    }
                    setModalMode(null);
                } catch(e) { alert("Action failed: " + e.message); }
                setLoading(false);
            };

            // --- DEPLOYMENTS & UTILS ---
            const handleDeployGas = async () => {
                setLoading(true);
                try {
                    const ver = await gasFetch(`https://script.googleapis.com/v1/projects/${currentRepo.scriptId}/versions`, "POST", { description: deployDesc });
                    const existing = await gasFetch(`https://script.googleapis.com/v1/projects/${currentRepo.scriptId}/deployments`);
                    const webApp = existing.deployments?.find(d => d.deploymentConfig?.scriptId); 
                    
                    if(webApp) {
                        await gasFetch(`https://script.googleapis.com/v1/projects/${currentRepo.scriptId}/deployments/${webApp.deploymentId}`, "PUT", {
                            deploymentConfig: { versionNumber: ver.versionNumber, description: deployDesc, manifestFileName: "appsscript" }
                        });
                        alert(`Updated Deployment to v${ver.versionNumber}`);
                    } else {
                        await gasFetch(`https://script.googleapis.com/v1/projects/${currentRepo.scriptId}/deployments`, "POST", {
                            versionNumber: ver.versionNumber,
                            description: deployDesc,
                            manifestFileName: "appsscript"
                        });
                        alert(`Created Deployment v${ver.versionNumber}`);
                    }
                    setModalMode(null);
                } catch(e) { alert("Deploy failed: " + e.message); }
                setLoading(false);
            };

            const handleGasUrl = async (repo, action) => {
                toast("Fetching URL...");
                try {
                    const res = await gasFetch(`https://script.googleapis.com/v1/projects/${repo.scriptId}/deployments`);
                    const dep = res.deployments?.find(d => d.entryPoints?.some(e => e.webApp));
                    
                    if (dep) {
                        const url = dep.entryPoints.find(e => e.webApp).webApp.url;
                        if (action === 'open') {
                            window.open(url, '_blank');
                        } else {
                            navigator.clipboard.writeText(url);
                            toast("Copied!");
                        }
                    } else {
                        alert("No Web App deployment found.");
                    }
                } catch(e) { 
                    console.error(e);
                    alert("Failed to fetch URL."); 
                }
            };

            const handleUpdateManifest = async () => {
                setLoading(true);
                try {
                    const res = await gasFetch(`https://script.googleapis.com/v1/projects/${currentRepo.scriptId}/content`);
                    let manifest = res.files.find(f => f.name === 'appsscript' && f.type === 'JSON');
                    let json = manifest ? JSON.parse(manifest.source) : {};
                    json.webapp = { access: gasAccess, executeAs: gasExecute };
                    const newFiles = res.files.map(f => f.name === 'appsscript' ? { ...f, source: JSON.stringify(json, null, 2) } : f);
                    await gasFetch(`https://script.googleapis.com/v1/projects/${currentRepo.scriptId}/content`, "PUT", { files: newFiles });
                    toast("Permissions Updated");
                    setModalMode(null);
                } catch(e) { alert("Update failed: " + e.message); }
                setLoading(false);
            };

            // --- ACTIONS ---
            const handleCreate = async () => {
                if(!inputName) return;
                
                if (modalMode === 'createRepo') { 
                    setModalMode(null); 
                    setLoading(true);
                    try {
                        if(service === 'git') {
                            await octokit.repos.createForAuthenticatedUser({ name: inputName, auto_init: true }); 
                        } else {
                            await gasFetch("https://script.googleapis.com/v1/projects", "POST", { title: inputName }); 
                        }
                        loadData();
                    } catch(e) { alert("Create Failed: " + e.message); setLoading(false); }
                } 
                else if(modalMode === 'createFile') {
                    setFilePath(inputName); setFileContent(""); setCommitMsg("Init"); setView("editor");
                    setModalMode(null);
                }
                setInputName("");
            };

            const switchService = (s) => {
                localStorage.setItem("service", s); setService(s); setRepos([]); setFiles([]); setView('repos');
            };

            const repoAction = async (action, repo, e) => {
                e.stopPropagation();
                if (action === 'delete') {
                    if (prompt(`Type '${repo.name}' to delete:`) !== repo.name) return;
                    setLoading(true);
                    try { 
                        if(service === 'git') {
                            await octokit.repos.delete({ owner: repo.owner.login, repo: repo.name }); 
                        } else {
                            await gasFetch(`https://www.googleapis.com/drive/v3/files/${repo.scriptId}`, "DELETE");
                        }
                        setRepos(repos.filter(r => (r.id || r.scriptId) !== (repo.id || repo.scriptId)));
                        toast("Deleted Project");
                    } catch(e) { alert("Delete failed: " + e.message); }
                    setLoading(false);
                } else if (action === 'pages') {
                    // Git Pages Logic
                } else if (action === 'launch') {
                    if(service === 'git') window.open(`https://${repo.owner.login}.github.io/${repo.name}/`, '_blank');
                    else window.open(`https://script.google.com/d/${repo.scriptId}/edit`, '_blank');
                }
            };

            const handlePaste = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if(confirm("Overwrite file?")) setFileContent(text);
                } catch (err) { 
                    setManualPasteText("");
                    setModalMode('pasteFallback');
                }
            };
            const confirmManualPaste = () => {
                if(manualPasteText) { setFileContent(manualPasteText); toast("Pasted"); }
                setModalMode(null);
            }

            const isLoggedIn = (service === 'git' && ghToken) || (service === 'gas' && gasToken);

            if (!isLoggedIn) {
                return (
                    <div className="flex flex-col items-center justify-center h-screen p-6 bg-gray-50 dark:bg-slate-950 gap-4">
                        <h1 className="text-3xl font-bold mb-2 bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">MobileDev</h1>
                        <div className="flex gap-4">
                            <button onClick={() => { setService('git'); window.location.href = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&redirect_uri=${window.location.href.split('?')[0]}&scope=repo,delete_repo`; }} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg active:scale-95 transition">
                                <Icons.Git /> GitHub
                            </button>
                            <button onClick={() => { setService('gas'); googleLogin(); }} className="bg-white text-slate-900 border border-gray-300 px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg active:scale-95 transition">
                                <span className="text-blue-500"><Icons.Drive /></span> Google
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-2xl mx-auto h-[100dvh] flex flex-col relative text-slate-900 dark:text-gray-100" onClick={() => setShowGlobalMenu(false)}>
                    <div className="sticky top-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur border-b border-gray-200 dark:border-slate-800 p-3 flex items-center justify-between z-50">
                        <div className="flex items-center gap-2 overflow-hidden">
                            {view !== "repos" && <button onClick={() => view === 'editor' ? setView('files') : loadData()} className="p-1.5 bg-gray-100 dark:bg-slate-800 rounded-full"><Icons.Back /></button>}
                            <h1 className="font-bold truncate text-sm">{(view === "repos" ? (service === 'git' ? "GitHub Repos" : "GAS Projects") : (path || "/"))}</h1>
                        </div>
                        <div className="flex items-center gap-1">
                            {view === "repos" && (
                                <button onClick={() => switchService(service === 'git' ? 'gas' : 'git')} className="p-2 bg-gray-100 dark:bg-slate-800 rounded-full">
                                    {service === 'git' ? <Icons.Git /> : <span className="text-blue-500"><Icons.Drive /></span>}
                                </button>
                            )}
                            {(view !== "editor") && <button onClick={() => { setInputName(""); setModalMode('create'+(view==='repos'?'Repo':'File')); }} className="p-2 bg-blue-600 text-white rounded-full active:scale-90"><Icons.Plus /></button>}
                            <button onClick={toggleTheme} className="p-2 rounded-full text-lg">ðŸŒ—</button>
                            <button onClick={(e) => { e.stopPropagation(); setShowGlobalMenu(!showGlobalMenu); }} className="p-2"><Icons.Menu /></button>
                        </div>
                    </div>

                    {showGlobalMenu && (
                        <div className="menu-dropdown bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg shadow-xl p-1 flex flex-col">
                            <button onClick={() => window.location.reload()} className="flex gap-2 p-2.5 hover:bg-gray-100 dark:hover:bg-slate-700 rounded text-sm"><span className="text-emerald-500"><Icons.Refresh /></span> Refresh</button>
                            {service === 'gas' && <button onClick={googleLogin} className="flex gap-2 p-2.5 hover:bg-gray-100 dark:hover:bg-slate-700 rounded text-sm"><span className="text-blue-500"><Icons.Drive /></span> Grant Permissions</button>}
                            <div className="h-px bg-gray-200 dark:bg-slate-700 my-1"></div>
                            <button onClick={logout} className="flex gap-2 p-2.5 hover:bg-gray-100 dark:hover:bg-slate-700 rounded text-sm text-red-500"><Icons.Logout /> Logout</button>
                        </div>
                    )}

                    {modalMode && (
                        <div className="modal-bg">
                            <div className="bg-white dark:bg-slate-800 p-4 rounded-lg w-10/12 max-w-xs shadow-2xl space-y-3">
                                <h3 className="font-bold">{
                                    modalMode === 'createRepo' ? 'New Project' : 
                                    modalMode === 'createFile' ? 'New File' : 
                                    modalMode === 'deployGas' ? 'Deploy / Update' : 
                                    modalMode === 'renameRepo' ? 'Rename Project' :
                                    modalMode === 'pasteFallback' ? 'Paste Content' :
                                    'Permissions'
                                }</h3>
                                
                                {modalMode === 'pasteFallback' ? (
                                    <textarea autoFocus className="w-full bg-gray-50 dark:bg-slate-900 border border-gray-300 dark:border-slate-600 rounded p-2 h-32" value={manualPasteText} onChange={e => setManualPasteText(e.target.value)}></textarea>
                                ) : null}

                                {(modalMode === 'createRepo' || modalMode === 'createFile' || modalMode === 'renameRepo') && (
                                    <input autoFocus placeholder="Name..." className="w-full bg-gray-50 dark:bg-slate-900 border border-gray-300 dark:border-slate-600 rounded p-2 outline-none" value={inputName} onChange={e => setInputName(e.target.value)} />
                                )}

                                {modalMode === 'deployGas' && (
                                    <input placeholder="Version Description" className="w-full bg-gray-50 dark:bg-slate-900 border border-gray-300 dark:border-slate-600 rounded p-2 outline-none" value={deployDesc} onChange={e => setDeployDesc(e.target.value)} />
                                )}

                                {modalMode === 'manifestGas' && (
                                    <div className="space-y-2">
                                        <label className="text-xs text-gray-500">Execute As</label>
                                        <select value={gasExecute} onChange={e => setGasExecute(e.target.value)} className="w-full bg-gray-50 dark:bg-slate-900 p-2 rounded border border-gray-300 dark:border-slate-600">
                                            <option value="USER_DEPLOYING">Me (User Deploying)</option>
                                            <option value="USER_ACCESSING">User Accessing</option>
                                        </select>
                                        <label className="text-xs text-gray-500">Who has access</label>
                                        <select value={gasAccess} onChange={e => setGasAccess(e.target.value)} className="w-full bg-gray-50 dark:bg-slate-900 p-2 rounded border border-gray-300 dark:border-slate-600">
                                            <option value="ANYONE_ANONYMOUS">Anyone (Anonymous)</option>
                                            <option value="ANYONE">Anyone (Google Account)</option>
                                            <option value="MYSELF">Only Myself</option>
                                        </select>
                                    </div>
                                )}

                                <div className="flex gap-2">
                                    <button onClick={() => setModalMode(null)} className="flex-1 p-2 text-gray-500 font-bold bg-gray-100 dark:bg-slate-700 rounded">Cancel</button>
                                    <button onClick={() => {
                                        if(modalMode === 'deployGas') handleDeployGas();
                                        else if(modalMode === 'manifestGas') handleUpdateManifest();
                                        else if(modalMode === 'renameRepo') performRename();
                                        else if(modalMode === 'pasteFallback') confirmManualPaste();
                                        else handleCreate();
                                    }} className="flex-1 p-2 bg-blue-600 text-white font-bold rounded">Confirm</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="p-2 flex-1 relative overflow-hidden">
                        {loading && <div className="absolute inset-0 bg-white/50 dark:bg-slate-900/50 z-10 flex pt-20 justify-center"><div className="loader"></div></div>}

                        {!loading && view === "repos" && (
                            <div className="h-full overflow-y-auto space-y-2 pb-20">
                                {repos.length === 0 && <div className="text-center text-gray-400 mt-10">Empty</div>}
                                {repos.map(r => (
                                    <div key={r.id || r.scriptId} className="bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-slate-700 overflow-hidden shadow-sm">
                                        <div onClick={() => loadFiles(r)} className="p-3 active:bg-gray-50 dark:active:bg-slate-700 cursor-pointer">
                                            <div className="flex justify-between items-start">
                                                <h3 className="font-semibold text-base text-blue-600 dark:text-blue-100">{r.name || r.title}</h3>
                                            </div>
                                            {r.updated_at && <p className="text-xs text-gray-500 mt-1">{formatDate(r.updated_at)}</p>}
                                        </div>
                                        <div className="flex divide-x divide-gray-200 dark:divide-slate-700 bg-gray-50 dark:bg-slate-800/50">
                                            {service === 'git' ? (
                                                <>
                                                    <button onClick={(e) => { e.stopPropagation(); alert("Pages"); }} className="flex-1 p-2 flex justify-center text-yellow-500"><Icons.Zap /></button>
                                                    <button onClick={(e) => { e.stopPropagation(); window.open(`https://${r.owner.login}.github.io/${r.name}/`); }} className="flex-1 p-2 flex justify-center text-blue-500"><Icons.Globe /></button>
                                                    <button onClick={(e) => repoAction('delete', r, e)} className="flex-1 p-2 flex justify-center text-red-500"><Icons.Trash /></button>
                                                </>
                                            ) : (
                                                <>
                                                    <button onClick={(e) => { e.stopPropagation(); setCurrentRepo(r); setModalMode('manifestGas'); }} className="flex-1 p-2 flex justify-center text-purple-500"><Icons.Settings /></button>
                                                    <button onClick={(e) => { e.stopPropagation(); setCurrentRepo(r); setModalMode('deployGas'); }} className="flex-1 p-2 flex justify-center text-green-500"><Icons.Zap /></button>
                                                    <button onClick={(e) => { e.stopPropagation(); setInputName(r.name); setCurrentRepo(r); setModalMode('renameRepo'); }} className="flex-1 p-2 flex justify-center text-orange-500"><Icons.Edit /></button>
                                                    
                                                    {/* UPDATED: Two buttons for Copy and Open */}
                                                    <button onClick={(e) => { e.stopPropagation(); handleGasUrl(r, 'copy'); }} className="flex-1 p-2 flex justify-center text-gray-500 hover:text-blue-500" title="Copy URL"><Icons.Copy /></button>
                                                    <button onClick={(e) => { e.stopPropagation(); handleGasUrl(r, 'open'); }} className="flex-1 p-2 flex justify-center text-blue-500 hover:text-blue-700" title="Open URL"><Icons.Link /></button>
                                                    
                                                    <button onClick={(e) => repoAction('delete', r, e)} className="flex-1 p-2 flex justify-center text-red-500"><Icons.Trash /></button>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {!loading && view === "files" && (
                            <div className="h-full overflow-y-auto flex flex-col gap-1 pb-20">
                                {files.map(f => (
                                    <div key={f.sha || f.name} className="flex items-center gap-2 p-2.5 bg-white dark:bg-slate-800 rounded border border-gray-200 dark:border-slate-700 shadow-sm">
                                        <div className="flex-1 flex items-center gap-2 cursor-pointer" onClick={() => f.type === "dir" ? alert("Dir") : openFile(f)}>
                                            {f.type === "dir" ? <Icons.Folder /> : <Icons.File />}
                                            <span className="truncate text-sm">{f.name}</span>
                                        </div>
                                        <button onClick={() => performDeleteFile(f)} className="p-1 text-red-400 hover:text-red-600"><Icons.Trash /></button>
                                    </div>
                                ))}
                            </div>
                        )}

                        {!loading && view === "editor" && (
                            <div className="flex flex-col h-full relative">
                                <textarea className="flex-1 w-full bg-gray-50 dark:bg-slate-900 text-slate-900 dark:text-gray-200 p-3 rounded-lg font-mono border border-gray-300 dark:border-slate-700 resize-none outline-none mb-14" value={fileContent} onChange={e => setFileContent(e.target.value)} spellCheck="false"></textarea>
                                <div className="fixed bottom-0 left-0 w-full bg-white dark:bg-slate-900 border-t border-gray-200 dark:border-slate-800 p-2 flex gap-2 items-center z-50">
                                    <button onClick={handlePaste} className="p-2"><Icons.Paste /></button>
                                    <button onClick={() => {navigator.clipboard.writeText(fileContent); toast("Copied");}} className="p-2"><Icons.Copy /></button>
                                    <input value={commitMsg} onChange={e => setCommitMsg(e.target.value)} className="flex-1 bg-gray-100 dark:bg-slate-800 rounded px-2 py-1.5 outline-none border border-gray-200 dark:border-slate-700" placeholder="Msg" />
                                    <button onClick={saveFile} className="bg-green-600 text-white p-2 rounded shadow-sm"><Icons.Save /></button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>